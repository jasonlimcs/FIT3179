{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": 720,
  "height": 340,
  "title": { "text": "ARR by ASGS Remoteness (Weighted by Students FTE) - 2024", "fontSize": 18 },

  "data": {
    "url": "https://raw.githubusercontent.com/jasonlimcs/FIT3179/main/DataVis2/remoteness.csv"
  },

  "transform": [
    { "filter": "toNumber(datum.year) == 2024" },

    { "calculate": "datum.state_name + '|' + datum.year + '|' + datum.affiliation", "as": "join_key" },

    {
      "lookup": "join_key",
      "from": {
        "data": {
          "url": "https://raw.githubusercontent.com/jasonlimcs/FIT3179/main/DataVis2/abs_arr_remoteness_2024.csv"
        },
        "key": "join_key",
        "fields": ["arr_all"]
      }
    },

    { "calculate": "toNumber(datum.arr_all)", "as": "ARR_state_proxy" },
    { "calculate": "toNumber(datum.students_fte)", "as": "StudentsFTE" },

    { "calculate": "datum.ARR_state_proxy * datum.StudentsFTE", "as": "wARR" },
    {
      "aggregate": [
        { "op": "sum", "field": "wARR", "as": "sum_wARR" },
        { "op": "sum", "field": "StudentsFTE", "as": "sum_StudentsFTE" }
      ],
      "groupby": ["remoteness"]
    },
    { "calculate": "datum.sum_wARR / datum.sum_StudentsFTE", "as": "ARR_weighted" },

    {
      "joinaggregate": [
        { "op": "sum", "field": "sum_StudentsFTE", "as": "AllStudentsFTE" }
      ]
    },
    { "calculate": "datum.sum_StudentsFTE / datum.AllStudentsFTE", "as": "PopShare" }
  ],

  "layer": [
    {
      "transform": [
        { "aggregate": [{ "op": "mean", "field": "ARR_weighted", "as": "NatAvg" }] }
      ],
      "mark": { "type": "rule", "strokeDash": [4,3], "stroke": "#666", "opacity": 0.8 },
      "encoding": { "x": { "field": "NatAvg", "type": "quantitative" } }
    },

    {
      "mark": { "type": "rule", "stroke": "#b0b0b0", "strokeWidth": 3, "opacity": 0.7 },
      "encoding": {
        "y": {
          "field": "remoteness", "type": "nominal", "title": null,
          "sort": ["Major Cities", "Inner Regional", "Outer Regional", "Remote", "Very Remote"]
        },
        "x": { "field": "ARR_weighted", "type": "quantitative"},
        "x2": { "value": 0 },
        "tooltip": [
          { "field": "remoteness", "title": "ASGS remoteness" },
          { "field": "ARR_weighted", "title": "ARR (weighted, %)", "format": ".1f" },
          { "field": "PopShare", "title": "Population share", "format": ".1%" },
          { "field": "sum_StudentsFTE", "title": "Students (FTE)", "format": "," }
        ]
      }
    },

    {
      "mark": { "type": "point", "filled": true, "stroke": "#333", "strokeWidth": 0.5 },
      "encoding": {
        "y": {
          "field": "remoteness", "type": "nominal", "title": null,
          "sort": ["Major Cities", "Inner Regional", "Outer Regional", "Remote", "Very Remote"]
        },
        "x": { "field": "ARR_weighted", "type": "quantitative", "title": "Capped ARR (%)", "axis": { "grid": false } },
        "size": { "field": "PopShare", "type": "quantitative", "title": "Population share", "scale": { "range": [80, 600] } },
        "color": { "value": "#1976d2" }
      }
    },

    {
      "mark": { "type": "text", "dx": 6, "align": "left", "fontSize": 11, "color": "#333" },
      "encoding": {
        "y": {
          "field": "remoteness", "type": "nominal",
          "sort": ["Major Cities", "Inner Regional", "Outer Regional", "Remote", "Very Remote"]
        },
        "x": { "field": "ARR_weighted", "type": "quantitative" },
        "text": { "field": "ARR_weighted", "type": "quantitative", "format": ".1f" }
      }
    }
  ],

  "config": {
    "axisY": { "labelPadding": 6 },
    "legend": { "orient": "right" }
  }
}

