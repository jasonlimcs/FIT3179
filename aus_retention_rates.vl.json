{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  

  "params": [
    {
      "name": "pCohort",
      "value": "Year 10 - Year 12",
      "bind": {
        "input": "select",
        "options": [
          "Year 7/8 - Year 10",
          "Year 7/8 - Year 11",
          "Year 7/8 - Year 12",
          "Year 10 - Year 12"
        ],
        "name": "Cohort: "
      }
    },
    {
      "name": "pAffil",
      "value": "All affiliations",
      "bind": {
        "input": "select",
        "options": ["All affiliations", "Government", "Non-Government", "Catholic", "Independent"],
        "name": "Sector: "
      }
    },
    {
      "name": "pSex",
      "value": "Persons",
      "bind": {
        "input": "select",
        "options": ["Persons", "Male", "Female"],
        "labels": ["All", "Male", "Female"],
        "name": "Sex: "
      }
    },
    {
      "name": "pMeasure",
      "value": "arr_all",
      "bind": {
        "input": "select",
        "options": ["arr_all", "arr_indigenous", "arr_non_indigenous"],
        "labels": ["All", "Aboriginal & Torres Strait Islander", "Non-Indigenous"],
        "name": "Measure: "
      }
    },
    {
      "name": "pYearScatter",
      "value": 2024,
      "bind": {
        "input": "range",
        "min": 2011,
        "max": 2024,
        "step": 1,
        "name": "Select year: "
      }
    }
    
  ],

  "vconcat": [
    {
      "width": 600,
      "height": 600,
      "title": {
        "text": "Apparent Retention Rates (ARR) in Australia by State, 2011-2024",
        "anchor": "middle",
        "fontSize": 18,
        "font": "sans-serif"
      },
      "layer": [
        {
          "data": { "values": [{}] },
          "mark": { "type": "rect", "aria": false },
          "encoding": {
            "x": { "datum": 0, "axis": null },
            "x2": { "datum": 600 },
            "y": { "datum": 0, "axis": null },
            "y2": { "datum": 600 },
            "color": { "value": "#cce6ff" }
          }
        },
        {
          "data": {
            "url": "https://raw.githubusercontent.com/jasonlimcs/FIT3179/main/DataVis2/output2.topojson",
            "format": { "type": "topojson", "feature": "ne_110m_graticules_5" }
          },
          "mark": { "type": "geoshape", "filled": false, "strokeWidth": 0.6 },
          "encoding": { "stroke": { "value": "#636363" } }
        },
        {
          "data": { "url": "https://raw.githubusercontent.com/jasonlimcs/FIT3179/main/DataVis2/abs_arr_2011_2024_long_with_joinkey.csv" },
          "transform": [
            { "filter": "datum.cohort == pCohort && datum.affiliation == pAffil && datum.sex == pSex" },
            { "fold": ["arr_all", "arr_indigenous", "arr_non_indigenous"], "as": ["measure", "arr_value"] },
            { "filter": "datum.measure == pMeasure" },
            { "calculate": "toNumber(datum.year)", "as": "YearNum" },
            { "calculate": "toNumber(datum.arr_value)", "as": "ARR" },
            { "filter": { "param": "yearBrush" } },
            { "aggregate": [{ "op": "mean", "field": "ARR", "as": "ARR_Avg" }], "groupby": ["state_name"] },
            {
              "lookup": "state_name",
              "from": {
                "data": {
                  "url": "https://raw.githubusercontent.com/jasonlimcs/FIT3179/main/DataVis2/output2.topojson",
                  "format": { "type": "topojson", "feature": "STE_2016_AUST" }
                },
                "key": "properties.STE_NAME16",
                "fields": ["geometry"]
              }
            }
          ],
          "mark": { "type": "geoshape", "filled": true, "strokeWidth": 1 },
          "encoding": {
            "shape": { "field": "geometry", "type": "geojson" },
            "color": {
              "field": "ARR_Avg",
              "type": "quantitative",
              "title": "Average ARR (%)",
              "scale": { "scheme": "reds" }
            },
            "stroke": { "value": "#333" },
            "tooltip": [
              { "field": "state_name", "title": "State/Territory" },
              { "field": "ARR_Avg", "title": "Avg ARR (%)", "format": ".1f" }
            ]
          }
        },
        {
          "data": { "url": "https://raw.githubusercontent.com/jasonlimcs/FIT3179/main/DataVis2/state_labels.csv" },
          "transform": [
            { "filter": "datum.STE_NAME16 != 'Other Territories'" },
            { "filter": "datum.STE_NAME16 != 'Australian Capital Territory'" }
          ],
          "mark": { "type": "text", "fontSize": 12, "color": "black", "fontWeight": "bold" },
          "encoding": {
            "longitude": { "field": "centroid_lon", "type": "quantitative" },
            "latitude": { "field": "centroid_lat", "type": "quantitative" },
            "text": { "field": "STE_NAME16" }
          }
        }
        
      ]
    },

    {
      "width": 600,
      "height": 320,
      "title": {
        "text": "State Retention Trends (2011-2024)",
        "fontSize": 18,
        "subtitle": "Use this line chart to filter out the data based on year",
        "subtitleFontSize": 12,
        "subtitleColor": "#555",
        "subtitlePadding": 6
      },
      "layer": [
        {
          "data": { "url": "https://raw.githubusercontent.com/jasonlimcs/FIT3179/main/DataVis2/abs_arr_2011_2024_long_with_joinkey.csv" },
          "transform": [
            { "filter": "datum.cohort == pCohort && datum.affiliation == pAffil && datum.sex == pSex" },
            { "fold": ["arr_all", "arr_indigenous", "arr_non_indigenous"], "as": ["measure", "arr_value"] },
            { "filter": "datum.measure == pMeasure" },
            { "calculate": "toNumber(datum.year)", "as": "YearNum" },
            { "calculate": "toNumber(datum.arr_value)", "as": "ARR" }
          ],
          "params": [
            {
              "name": "yearBrush",
              "select": { "type": "interval", "encodings": ["x"] }
            },
            {
              "name": "stateSel",
              "select": { "type": "point", "fields": ["state_name"] },
              "bind": "legend"
            }
          ],
          "mark": { "type": "line", "strokeWidth": 1 },
          "encoding": {
            "x": { "field": "YearNum", "type": "quantitative", "title": "Year", "scale": { "nice": false }, "axis": { "format": "d" } },
            "y": { "field": "ARR", "type": "quantitative", "title": "Retention rate (%)" },
            "color": {
              "field": "state_name",
              "type": "nominal",
              "title": "Click legend to focus",
              "legend": { "orient": "right" }
            },
            "opacity": { "condition": { "param": "stateSel", "empty": true, "value": 1 }, "value": 0.2 },
            "size": { "condition": { "param": "stateSel", "empty": true, "value": 2 }, "value": 1 },
            "tooltip": [
              { "field": "state_name", "title": "State/Territory" },
              { "field": "YearNum", "title": "Year", "format": "d" },
              { "field": "ARR", "title": "ARR (%)", "format": ".1f" },
              { "field": "cohort", "title": "Cohort" },
              { "field": "affiliation", "title": "Sector" },
              { "field": "sex", "title": "Sex" }
            ]
          }
        },

        {
          "data": { "url": "https://raw.githubusercontent.com/jasonlimcs/FIT3179/main/DataVis2/abs_arr_2011_2024_long_with_joinkey.csv" },
          "transform": [
            { "filter": "datum.cohort == pCohort && datum.affiliation == pAffil && datum.sex == pSex" },
            { "fold": ["arr_all", "arr_indigenous", "arr_non_indigenous"], "as": ["measure", "arr_value"] },
            { "filter": "datum.measure == pMeasure" },
            { "calculate": "toNumber(datum.year)", "as": "YearNum" },
            { "calculate": "toNumber(datum.arr_value)", "as": "ARR" },
            { "filter": { "param": "yearBrush" } }
          ],
          "mark": { "type": "line", "strokeWidth": 2 },
          "encoding": {
            "x": { "field": "YearNum", "type": "quantitative", "title": "Year", "scale": { "nice": false }, "axis": { "format": "d" } },
            "y": { "field": "ARR", "type": "quantitative", "title": "Retention rate (%)" },
            "color": { "field": "state_name", "type": "nominal"},
            "opacity": {
              "condition": [
                { "param": "stateSel", "empty": true, "value": 1 }
              ],
              "value": 0.2
            },
            "size": {
              "condition": [
                { "param": "stateSel", "empty": true, "value": 3 }
              ],
              "value": 2
            }
          }
        },

        {
          "data": { "url": "https://raw.githubusercontent.com/jasonlimcs/FIT3179/main/DataVis2/abs_arr_2011_2024_long_with_joinkey.csv" },
          "transform": [
            { "filter": "datum.cohort == pCohort && datum.affiliation == pAffil && datum.sex == pSex" },
            { "fold": ["arr_all", "arr_indigenous", "arr_non_indigenous"], "as": ["measure", "arr_value"] },
            { "filter": "datum.measure == pMeasure" },
            { "calculate": "toNumber(datum.year)", "as": "YearNum" },
            { "calculate": "toNumber(datum.arr_value)", "as": "ARR" },
            { "aggregate": [{ "op": "mean", "field": "ARR", "as": "NatAvg" }], "groupby": ["YearNum"] }
          ],
          "mark": { "type": "line", "strokeDash": [6, 4], "opacity": 0.9, "color": "black" },
          "encoding": {
            "x": { "field": "YearNum", "type": "quantitative" },
            "y": { "field": "NatAvg", "type": "quantitative" },
            "tooltip": [
              { "field": "NatAvg", "title": "National Average", "format": ".1f" }
            ]
          }
        },

        {
          "data": { "url": "https://raw.githubusercontent.com/jasonlimcs/FIT3179/main/DataVis2/abs_arr_2011_2024_long_with_joinkey.csv" },
          "transform": [
            { "filter": "datum.cohort == pCohort && datum.affiliation == pAffil && datum.sex == pSex" },
            { "fold": ["arr_all", "arr_indigenous", "arr_non_indigenous"], "as": ["measure", "arr_value"] },
            { "filter": "datum.measure == pMeasure" },
            { "calculate": "toNumber(datum.year)", "as": "YearNum" },
            { "calculate": "toNumber(datum.arr_value)", "as": "ARR" },
            { "aggregate": [{ "op": "mean", "field": "ARR", "as": "NatAvg" }], "groupby": ["YearNum"] },
            { "window": [{ "op": "row_number", "as": "rn" }], "sort": [{ "field": "YearNum", "order": "descending" }] },
            { "filter": "datum.rn == 1" }
          ],
          "mark": { "type": "text", "dx": -40, "dy": 12, "fontSize": 12, "fontStyle": "italic", "color": "black" },
          "encoding": {
            "x": { "field": "YearNum", "type": "quantitative" },
            "y": { "field": "NatAvg", "type": "quantitative" },
            "text": { "value": "National average" }
          }
        },

        {
          "data": { "values": [{ "YearNum": 2020, "label": "COVID-19 Disruption" }] },
          "mark": { "type": "text", "dx": 6, "dy": -110, "fontSize": 11, "fontStyle": "italic", "color": "black" },
          "encoding": {
            "x": { "field": "YearNum", "type": "quantitative" },
            "y": { "value": 100 },
            "text": { "field": "label" }
          }
        },

        {
          "data": { "values": [{ "YearNum": 2020 }] },
          "mark": { "type": "rule", "stroke": "black", "strokeDash": [3, 3] },
          "encoding": { "x": { "field": "YearNum", "type": "quantitative" } }
        }
      ]
    },

    {
      "width": 600,
      "height": 380,
      "title": {
        "text": "Student-Teacher Ratio vs Retention (selected year)",
        "fontSize": 18
      },
      "data": {"url": "https://raw.githubusercontent.com/jasonlimcs/FIT3179/main/DataVis2/abs_arr_2011_2024_long_with_joinkey.csv"},

      "transform": [
        { "filter": "datum.cohort == pCohort && datum.affiliation == pAffil && datum.sex == pSex" },
        { "fold": ["arr_all","arr_indigenous","arr_non_indigenous"], "as": ["measure","arr_value"] },
        { "filter": "datum.measure == pMeasure && toNumber(datum.year) == pYearScatter" },
        { "calculate": "toNumber(datum.arr_value)", "as": "ARR" },
        { "calculate": "toNumber(datum.year)", "as": "YearNum" },
  { "calculate": "datum.state_short + '|' + datum.year", "as": "join_key" },
        {
          "lookup": "join_key",
          "from": {
            "data": {
              "url": "https://raw.githubusercontent.com/jasonlimcs/FIT3179/main/DataVis2/abs_student_teacher_ratio_2006_2024_with_joinkey.csv"
            },
            "key": "join_key",
            "fields": ["ratio"]
          }
        },
        { "calculate": "toNumber(datum.ratio)", "as": "Ratio" }
      ],
      "layer": [
        {
          "mark": { "type": "point", "filled": true, "size": 120, "opacity": 0.9 },
          "encoding": {
            "x": { "field": "Ratio", "type": "quantitative", "title": "Student-teacher ratio (FTE students per FTE teacher)", "scale": { "zero": false, "nice": true } },
            "y": { "field": "ARR", "type": "quantitative", "title": "Capped ARR (%)", "scale": { "zero": false, "nice": true } },
            "color": { "field": "state_name", "type": "nominal", "title": "State" },
            "opacity": { "condition": { "param": "stateSel2", "value": 1 }, "value": 0.4 },
            "tooltip": [
              { "field": "state_name", "title": "State/Territory" },
              { "field": "YearNum", "title": "Year", "format": "d" },
              { "field": "ARR", "title": "ARR (%)", "format": ".1f" },
              { "field": "Ratio", "title": "Student-teacher ratio", "format": ".1f" },
              { "field": "cohort", "title": "Cohort" },
              { "field": "affiliation", "title": "Sector" },
              { "field": "sex", "title": "Sex" }
            ]
          },
          "params": [
            {
              "name": "stateSel2",
              "select": { "type": "point", "fields": ["state_name"] },
              "bind": "legend"
            }
          ]
        },
        {
          "transform": [{ "regression": "ARR", "on": "Ratio" }],
          "mark": { "type": "line", "stroke": "black", "strokeDash": [6,4], "opacity": 0.7 },
          "encoding": {
            "x": { "field": "Ratio", "type": "quantitative" },
            "y": { "field": "ARR", "type": "quantitative" }
          }
        },
        {
          "transform": [{ "aggregate": [{"op":"mean","field":"Ratio","as":"MeanRatio"}], "groupby": [] }],
          "mark": { "type": "rule", "stroke": "#666", "strokeDash": [3,3], "opacity": 0.8 },
          "encoding": { "x": { "field": "MeanRatio", "type": "quantitative" } }
        },
        {
          "transform": [{ "aggregate": [{"op":"mean","field":"ARR","as":"MeanARR"}], "groupby": [] }],
          "mark": { "type": "rule", "stroke": "#666", "strokeDash": [3,3], "opacity": 0.8 },
          "encoding": { "y": { "field": "MeanARR", "type": "quantitative" } }
        }
      ]
    },

    {
      "title": {
        "text": "Participation vs Retention by State (2011-2024)",
        "fontSize": 18,
        "subtitle": "Blue = Participation rate (ages 6-19), Red = Capped ARR",
        "subtitleFontSize": 12
      },
      "data": { "url": "https://raw.githubusercontent.com/jasonlimcs/FIT3179/main/DataVis2/abs_arr_2011_2024_long_with_joinkey.csv" },
      "transform": [
        { "filter": "datum.cohort == pCohort && datum.affiliation == pAffil && datum.sex == pSex" },
        { "fold": ["arr_all","arr_indigenous","arr_non_indigenous"], "as": ["measure","arr_value"] },
        { "filter": "datum.measure == pMeasure" },
        { "calculate": "toNumber(datum.year)", "as": "YearNum" },
        { "calculate": "toNumber(datum.arr_value)", "as": "ARR" },

        { "calculate": "datum.state_name + '|' + datum.year", "as": "join_key" },
        {
          "lookup": "join_key",
          "from": {
            "data": {
              "url": "https://raw.githubusercontent.com/jasonlimcs/FIT3179/main/DataVis2/abs_participation_rate_2011_2024.csv"
            },
            "key": "join_key",
            "fields": ["participation_rate"]
          }
        },
        { "calculate": "toNumber(datum.participation_rate)", "as": "PartRate" },

        { "fold": ["PartRate","ARR"], "as": ["series","pct"] }
      ],

      "facet": {
        "field": "state_name",
        "type": "nominal",
        "title": null,
        "header": { "labelAngle": 0, "labelFontSize": 12, "labelFontWeight": "bold" }
      },
      "columns": 3,

      "spec": {
        "width": 200,
        "height": 200,
        "layer": [
          {
            "mark": { "type": "line", "strokeWidth": 1 },
            "encoding": {
              "x": { "field": "YearNum", "type": "quantitative", "axis": { "format": "d", "title": "Year" } },
              "y": { "field": "pct", "type": "quantitative", "title": "Percent" },
              "color": {
                "field": "series",
                "type": "nominal",
                "title": null,
                "scale": { "domain": ["PartRate","ARR"], "range": ["#1f77b4","#d62728"] },
                "legend": { "orient": "top", "title": "Series" }
              },
              "opacity": { "value": 0.35 },
              "tooltip": [
                { "field": "state_name", "title": "State/Territory" },
                { "field": "YearNum", "title": "Year", "format": "d" },
                { "field": "series", "title": "Series",
                  "type": "nominal" },
                { "field": "pct", "title": "Value (%)", "format": ".1f" },
                { "field": "cohort", "title": "Cohort" },
                { "field": "affiliation", "title": "Sector" },
                { "field": "sex", "title": "Sex" }
              ]
            }
          },
          {
            "transform": [{ "filter": { "param": "yearBrush" } }],
            "mark": { "type": "line", "strokeWidth": 3 },
            "encoding": {
              "x": { "field": "YearNum", "type": "quantitative" },
              "y": { "field": "pct", "type": "quantitative" },
              "color": {
                "field": "series",
                "type": "nominal",
                "scale": { "domain": ["PartRate","ARR"], "range": ["#1f77b4","#d62728"] },
                "legend": null
              }
            }
          }
        ]
      }
    }

    
  ]
}
