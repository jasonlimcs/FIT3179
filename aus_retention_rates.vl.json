{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  

  "params": [
    {
      "name": "pCohort",
      "value": "Year 10 - Year 12",
      "bind": {
        "input": "select",
        "options": [
          "Year 7/8 - Year 10",
          "Year 7/8 - Year 11",
          "Year 7/8 - Year 12",
          "Year 10 - Year 12"
        ],
        "name": "Cohort: "
      }
    },
    {
      "name": "pAffil",
      "value": "All affiliations",
      "bind": {
        "input": "select",
        "options": ["All affiliations", "Government", "Non-Government", "Catholic", "Independent"],
        "name": "Sector: "
      }
    },
    {
      "name": "pSex",
      "value": "Persons",
      "bind": {
        "input": "select",
        "options": ["Persons", "Male", "Female"],
        "labels": ["All", "Male", "Female"],
        "name": "Sex: "
      }
    },
    {
      "name": "pMeasure",
      "value": "arr_all",
      "bind": {
        "input": "select",
        "options": ["arr_all", "arr_indigenous", "arr_non_indigenous"],
        "labels": ["All", "Aboriginal & Torres Strait Islander", "Non-Indigenous"],
        "name": "Measure: "
      }
    }
  ],

  "vconcat": [
    {
      "width": 600,
      "height": 600,
      "title": {
        "text": "Apparent Retention Rates (ARR) in Australia by State, 2011-2024",
        "anchor": "middle",
        "fontSize": 18,
        "font": "sans-serif"
      },
      "layer": [
        {
          "data": { "values": [{}] },
          "mark": { "type": "rect", "aria": false },
          "encoding": {
            "x": { "datum": 0, "axis": null },
            "x2": { "datum": 600 },
            "y": { "datum": 0, "axis": null },
            "y2": { "datum": 600 },
            "color": { "value": "#cce6ff" }
          }
        },
        {
          "data": {
            "url": "https://raw.githubusercontent.com/jasonlimcs/FIT3179/main/DataVis2/output2.topojson",
            "format": { "type": "topojson", "feature": "ne_110m_graticules_5" }
          },
          "mark": { "type": "geoshape", "filled": false, "strokeWidth": 0.6 },
          "encoding": { "stroke": { "value": "#636363" } }
        },
        {
          "data": { "url": "https://raw.githubusercontent.com/jasonlimcs/FIT3179/main/DataVis2/abs_arr_2011_2024_long_with_joinkey.csv" },
          "transform": [
            { "filter": "datum.cohort == pCohort && datum.affiliation == pAffil && datum.sex == pSex" },
            { "fold": ["arr_all", "arr_indigenous", "arr_non_indigenous"], "as": ["measure", "arr_value"] },
            { "filter": "datum.measure == pMeasure" },
            { "calculate": "toNumber(datum.year)", "as": "YearNum" },
            { "calculate": "toNumber(datum.arr_value)", "as": "ARR" },
            { "filter": { "param": "yearBrush" } },
            { "aggregate": [{ "op": "mean", "field": "ARR", "as": "ARR_Avg" }], "groupby": ["state_name"] },
            {
              "lookup": "state_name",
              "from": {
                "data": {
                  "url": "https://raw.githubusercontent.com/jasonlimcs/FIT3179/main/DataVis2/output2.topojson",
                  "format": { "type": "topojson", "feature": "STE_2016_AUST" }
                },
                "key": "properties.STE_NAME16",
                "fields": ["geometry"]
              }
            }
          ],
          "mark": { "type": "geoshape", "filled": true, "strokeWidth": 1 },
          "encoding": {
            "shape": { "field": "geometry", "type": "geojson" },
            "color": {
              "field": "ARR_Avg",
              "type": "quantitative",
              "title": "Average ARR (%)",
              "scale": { "scheme": "reds" }
            },
            "stroke": { "value": "#333" },
            "tooltip": [
              { "field": "state_name", "title": "State/Territory" },
              { "field": "ARR_Avg", "title": "Avg ARR (%)", "format": ".1f" }
            ]
          }
        },
        {
          "data": { "url": "https://raw.githubusercontent.com/jasonlimcs/FIT3179/main/DataVis2/state_labels.csv" },
          "transform": [
            { "filter": "datum.STE_NAME16 != 'Other Territories'" },
            { "filter": "datum.STE_NAME16 != 'Australian Capital Territory'" }
          ],
          "mark": { "type": "text", "fontSize": 12, "color": "black", "fontWeight": "bold" },
          "encoding": {
            "longitude": { "field": "centroid_lon", "type": "quantitative" },
            "latitude": { "field": "centroid_lat", "type": "quantitative" },
            "text": { "field": "STE_NAME16" }
          }
        }
        
      ]
    },

    {
      "width": 600,
      "height": 320,
      "title": { "text": "State trajectories of capped ARR, 2011-2024", "fontSize": 18 },
      "layer": [
        {
          "data": { "url": "https://raw.githubusercontent.com/jasonlimcs/FIT3179/main/DataVis2/abs_arr_2011_2024_long_with_joinkey.csv" },
          "transform": [
            { "filter": "datum.cohort == pCohort && datum.affiliation == pAffil && datum.sex == pSex" },
            { "fold": ["arr_all", "arr_indigenous", "arr_non_indigenous"], "as": ["measure", "arr_value"] },
            { "filter": "datum.measure == pMeasure" },
            { "calculate": "toNumber(datum.year)", "as": "YearNum" },
            { "calculate": "toNumber(datum.arr_value)", "as": "ARR" }
          ],
          "params": [
            {
              "name": "yearBrush",
              "select": { "type": "interval", "encodings": ["x"] }
            },
            {
              "name": "stateSel",
              "select": { "type": "point", "fields": ["state_name"] },
              "bind": "legend"
            }
          ],
          "mark": { "type": "line", "strokeWidth": 1 },
          "encoding": {
            "x": { "field": "YearNum", "type": "quantitative", "title": "Year", "scale": { "nice": false }, "axis": { "format": "d" } },
            "y": { "field": "ARR", "type": "quantitative", "title": "Retention rate (%)" },
            "color": {
              "field": "state_name",
              "type": "nominal",
              "title": "Click legend to focus",
              "legend": { "orient": "right" }
            },
            "opacity": { "condition": { "param": "stateSel", "empty": true, "value": 1 }, "value": 0.2 },
            "tooltip": [
              { "field": "state_name", "title": "State/Territory" },
              { "field": "YearNum", "title": "Year", "format": "d" },
              { "field": "ARR", "title": "ARR (%)", "format": ".1f" },
              { "field": "cohort", "title": "Cohort" },
              { "field": "affiliation", "title": "Sector" },
              { "field": "sex", "title": "Sex" }
            ]
          }
        },

        {
          "data": { "url": "https://raw.githubusercontent.com/jasonlimcs/FIT3179/main/DataVis2/abs_arr_2011_2024_long_with_joinkey.csv" },
          "transform": [
            { "filter": "datum.cohort == pCohort && datum.affiliation == pAffil && datum.sex == pSex" },
            { "fold": ["arr_all", "arr_indigenous", "arr_non_indigenous"], "as": ["measure", "arr_value"] },
            { "filter": "datum.measure == pMeasure" },
            { "calculate": "toNumber(datum.year)", "as": "YearNum" },
            { "calculate": "toNumber(datum.arr_value)", "as": "ARR" },
            { "filter": { "param": "yearBrush" } }
          ],
          "mark": { "type": "line", "strokeWidth": 2 },
          "encoding": {
            "x": { "field": "YearNum", "type": "quantitative", "title": "Year", "scale": { "nice": false }, "axis": { "format": "d" } },
            "y": { "field": "ARR", "type": "quantitative", "title": "Retention rate (%)" },
            "color": { "field": "state_name", "type": "nominal"},
            "opacity": { "condition": { "param": "stateSel", "empty": true, "value": 1 }, "value": 0.2 }
          }
        },

        {
          "data": { "url": "https://raw.githubusercontent.com/jasonlimcs/FIT3179/main/DataVis2/abs_arr_2011_2024_long_with_joinkey.csv" },
          "transform": [
            { "filter": "datum.cohort == pCohort && datum.affiliation == pAffil && datum.sex == pSex" },
            { "fold": ["arr_all", "arr_indigenous", "arr_non_indigenous"], "as": ["measure", "arr_value"] },
            { "filter": "datum.measure == pMeasure" },
            { "calculate": "toNumber(datum.year)", "as": "YearNum" },
            { "calculate": "toNumber(datum.arr_value)", "as": "ARR" },
            { "aggregate": [{ "op": "mean", "field": "ARR", "as": "NatAvg" }], "groupby": ["YearNum"] }
          ],
          "mark": { "type": "line", "strokeDash": [6, 4], "opacity": 0.9, "color": "black" },
          "encoding": {
            "x": { "field": "YearNum", "type": "quantitative" },
            "y": { "field": "NatAvg", "type": "quantitative" },
            "tooltip": [
              { "field": "NatAvg", "title": "National Average", "format": ".1f" }
            ]
          }
        },

        {
          "data": { "url": "https://raw.githubusercontent.com/jasonlimcs/FIT3179/main/DataVis2/abs_arr_2011_2024_long_with_joinkey.csv" },
          "transform": [
            { "filter": "datum.cohort == pCohort && datum.affiliation == pAffil && datum.sex == pSex" },
            { "fold": ["arr_all", "arr_indigenous", "arr_non_indigenous"], "as": ["measure", "arr_value"] },
            { "filter": "datum.measure == pMeasure" },
            { "calculate": "toNumber(datum.year)", "as": "YearNum" },
            { "calculate": "toNumber(datum.arr_value)", "as": "ARR" },
            { "aggregate": [{ "op": "mean", "field": "ARR", "as": "NatAvg" }], "groupby": ["YearNum"] },
            { "window": [{ "op": "row_number", "as": "rn" }], "sort": [{ "field": "YearNum", "order": "descending" }] },
            { "filter": "datum.rn == 1" }
          ],
          "mark": { "type": "text", "dx": -40, "dy": 12, "fontSize": 12, "fontStyle": "italic", "color": "black" },
          "encoding": {
            "x": { "field": "YearNum", "type": "quantitative" },
            "y": { "field": "NatAvg", "type": "quantitative" },
            "text": { "value": "National average" }
          }
        },

        {
          "data": { "values": [{ "YearNum": 2020, "label": "COVID-19 Disruption" }] },
          "mark": { "type": "text", "dx": 6, "dy": -110, "fontSize": 11, "fontStyle": "italic", "color": "black" },
          "encoding": {
            "x": { "field": "YearNum", "type": "quantitative" },
            "y": { "value": 100 },
            "text": { "field": "label" }
          }
        },

        {
          "data": { "values": [{ "YearNum": 2020 }] },
          "mark": { "type": "rule", "stroke": "black", "strokeDash": [3, 3] },
          "encoding": { "x": { "field": "YearNum", "type": "quantitative" } }
        }
      ]
    }
  ]
}
